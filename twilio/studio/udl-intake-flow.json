{
  "description": "UDL Intake EN/ES -> Subscriber check -> Local attorney or Aircall fallback",
  "states": [
    {
      "name": "trigger",
      "type": "trigger",
      "transitions": [{ "event": "incomingCall", "next": "greeting" }],
      "properties": { "offset": { "x": 30, "y": 30 } }
    },
    {
      "name": "greeting",
      "type": "say-play",
      "transitions": [{ "event": "audioComplete", "next": "gatherPractice" }],
      "properties": {
        "say": "Welcome to Ultima Defensa Legal. We are not a law firm; we connect you to independent attorneys. For immigration, family, employment, criminal, or accidents, please tell me your practice area after the tone.",
        "language": "en-US",
        "voice": "Polly.Matthew"
      }
    },
    {
      "name": "gatherPractice",
      "type": "gather-input-on-call",
      "transitions": [
        { "event": "keypress", "next": "gatherZip" },
        { "event": "speech", "next": "gatherZip" },
        { "event": "timeout", "next": "gatherZip" }
      ],
      "properties": {
        "stop_gather": "true",
        "gather_language": "en-US",
        "hints": "immigration,family,employment,criminal,accident",
        "say": "Please say immigration, family, employment, criminal, or accident.",
        "speech_timeout": "auto",
        "input": "speech dtmf",
        "num_digits": "1",
        "timeout": "5"
      }
    },
    {
      "name": "gatherZip",
      "type": "gather-input-on-call",
      "transitions": [
        { "event": "keypress", "next": "checkSubscriber" },
        { "event": "speech", "next": "checkSubscriber" },
        { "event": "timeout", "next": "checkSubscriber" }
      ],
      "properties": {
        "stop_gather": "true",
        "gather_language": "en-US",
        "say": "Please say or enter your five digit zip code.",
        "speech_timeout": "auto",
        "input": "speech dtmf",
        "num_digits": "5",
        "timeout": "5"
      }
    },
    {
      "name": "checkSubscriber",
      "type": "http-request",
      "transitions": [
        { "event": "success", "next": "branchSubscriber" },
        { "event": "failed", "next": "fallbackAircall" }
      ],
      "properties": {
        "method": "POST",
        "content_type": "application/json",
        "url": "https://YOUR_DOMAIN/api/ivr/check-subscriber",
        "body": "{\"phone\":\"{{contact.channel.address}}\"}"
      }
    },
    {
      "name": "branchSubscriber",
      "type": "split-based-on",
      "transitions": [
        { "event": "noMatch", "next": "fallbackAircall" },
        { "event": "match", "next": "routeLookup" }
      ],
      "properties": {
        "input": "{{widgets.checkSubscriber.parsed.isSubscriber}}",
        "cases": [{ "value": "true", "next": "routeLookup" }]
      }
    },
    {
      "name": "routeLookup",
      "type": "http-request",
      "transitions": [
        { "event": "success", "next": "dialTargets" },
        { "event": "failed", "next": "fallbackAircall" }
      ],
      "properties": {
        "method": "POST",
        "content_type": "application/json",
        "url": "https://YOUR_DOMAIN/api/ivr/route",
        "body": "{\"toNumberE164\":\"{{trigger.call.To}}\",\"zip\":\"{{widgets.gatherZip.SpeechResult}}\",\"practice\":\"{{widgets.gatherPractice.SpeechResult}}\"}"
      }
    },
    {
      "name": "dialTargets",
      "type": "connect-call-to",
      "transitions": [{ "event": "callCompleted", "next": "end" }],
      "properties": {
        "caller_id": "{{trigger.call.To}}",
        "record": "record-from-answer",
        "noun": "number",
        "to": "{{widgets.routeLookup.parsed.targets}}"
      }
    },
    {
      "name": "fallbackAircall",
      "type": "connect-call-to",
      "transitions": [{ "event": "callCompleted", "next": "smsSignup" }],
      "properties": {
        "caller_id": "{{trigger.call.To}}",
        "record": "record-from-answer",
        "noun": "number",
        "to": "+1XXXYYYZZZZ"  // Aircall queue/number
      }
    },
    {
      "name": "smsSignup",
      "type": "send-message",
      "transitions": [{ "event": "sent", "next": "end" }, { "event": "failed", "next": "end" }],
      "properties": {
        "from": "{{trigger.call.To}}",
        "to": "{{contact.channel.address}}",
        "body": "To connect with a local attorney, please complete your membership: https://ultimadefensalegal.com/client-pay.html"
      }
    },
    { "name": "end", "type": "hang-up", "transitions": [], "properties": {} }
  ],
  "initial_state": "trigger",
  "flags": { "allow_concurrent_calls": true }
}
