{
  "description": "UDL Inbound City Flow — ANI check → Member ID → OTP → Queue",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        { "event": "incomingCall", "next": "Set_MetroKey" }
      ]
    },
    {
      "name": "Set_MetroKey",
      "type": "set-variables",
      "properties": {
        "variables": [
          { "key": "metro_key", "value": "{{flow.data.metro_key}}" },
          { "key": "from_number", "value": "{{trigger.call.From}}" }
        ]
      },
      "transitions": [{ "event": "next", "next": "Check_ANI" }]
    },
    {
      "name": "Check_ANI",
      "type": "make-http-request",
      "properties": {
        "method": "POST",
        "content_type": "application/json",
        "url": "https://YOUR_NETLIFY_SITE_URL/.netlify/functions/members-lookup",
        "body": "{\"from\":\"{{widgets.Set_MetroKey.variables.from_number}}\",\"metro_key\":\"{{widgets.Set_MetroKey.variables.metro_key}}\"}",
        "timeout": 10
      },
      "transitions": [
        {
          "event": "success",
          "conditions": [
            { "friendly_name": "Allow True", "type": "equal_to", "value": "true", "variable": "{{widgets.Check_ANI.parsed.allow}}" }
          ],
          "next": "Route_To_Queue"
        },
        { "event": "success", "next": "Prompt_MemberID" },
        { "event": "failed", "next": "Say_Error" }
      ]
    },
    {
      "name": "Prompt_MemberID",
      "type": "gather-input-on-call",
      "properties": {
        "say": "Please enter your Member I D, followed by the pound key.",
        "voice": "Polly.Matthew",
        "language": "en-US",
        "finish_on_key": "#",
        "timeout": 8,
        "num_digits": 12
      },
      "transitions": [
        { "event": "keypress", "next": "Start_OTP" },
        { "event": "timeout", "next": "Say_Goodbye" }
      ]
    },
    {
      "name": "Start_OTP",
      "type": "make-http-request",
      "properties": {
        "method": "POST",
        "content_type": "application/json",
        "url": "https://YOUR_NETLIFY_SITE_URL/.netlify/functions/members-lookup",
        "body": "{\"member_id\":\"{{widgets.Prompt_MemberID.Digits}}\",\"step\":\"start\"}",
        "timeout": 10
      },
      "transitions": [
        {
          "event": "success",
          "conditions": [
            { "friendly_name": "Send Code", "type": "equal_to", "value": "send_code", "variable": "{{widgets.Start_OTP.parsed.action}}" }
          ],
          "next": "Send_Code_SMS"
        },
        { "event": "success", "next": "Say_NotActive" },
        { "event": "failed", "next": "Say_Error" }
      ]
    },
    {
      "name": "Send_Code_SMS",
      "type": "send-message",
      "properties": {
        "from": "{{flow.data.sms_from_number}}",
        "to": "{{widgets.Set_MetroKey.variables.from_number}}",
        "body": "UDL code: {{widgets.Start_OTP.parsed.code}} (valid 5 minutes)."
      },
      "transitions": [{ "event": "sent", "next": "Prompt_OTP" }]
    },
    {
      "name": "Prompt_OTP",
      "type": "gather-input-on-call",
      "properties": {
        "say": "Enter the six digit code we just texted to your phone, then press pound.",
        "voice": "Polly.Matthew",
        "language": "en-US",
        "finish_on_key": "#",
        "timeout": 15,
        "num_digits": 6
      },
      "transitions": [
        { "event": "keypress", "next": "Verify_OTP" },
        { "event": "timeout", "next": "Say_Goodbye" }
      ]
    },
    {
      "name": "Verify_OTP",
      "type": "make-http-request",
      "properties": {
        "method": "POST",
        "content_type": "application/json",
        "url": "https://YOUR_NETLIFY_SITE_URL/.netlify/functions/members-lookup",
        "body": "{\"member_id\":\"{{widgets.Prompt_MemberID.Digits}}\",\"otp\":\"{{widgets.Prompt_OTP.Digits}}\",\"step\":\"verify\"}",
        "timeout": 10
      },
      "transitions": [
        {
          "event": "success",
          "conditions": [
            { "friendly_name": "Allow True", "type": "equal_to", "value": "true", "variable": "{{widgets.Verify_OTP.parsed.allow}}" }
          ],
          "next": "Route_To_Queue"
        },
        { "event": "success", "next": "Say_BadCode" },
        { "event": "failed", "next": "Say_Error" }
      ]
    },
    {
      "name": "Route_To_Queue",
      "type": "enqueue-call",
      "properties": {
        "queue_name": "{{widgets.Set_MetroKey.variables.metro_key}}_attorneys"
      },
      "transitions": [
        { "event": "queued", "next": "Say_Queued" },
        { "event": "callComplete", "next": "Say_Goodbye" }
      ]
    },
    {
      "name": "Say_Queued",
      "type": "say-play",
      "properties": {
        "say": "Please hold while we connect you to a local attorney."
      },
      "transitions": [{ "event": "audioComplete", "next": "Hangup" }]
    },
    {
      "name": "Say_NotActive",
      "type": "say-play",
      "properties": {
        "say": "Your membership is not active. Please visit our website to subscribe."
      },
      "transitions": [{ "event": "audioComplete", "next": "Hangup" }]
    },
    {
      "name": "Say_BadCode",
      "type": "say-play",
      "properties": {
        "say": "The code you entered is invalid or expired. Goodbye."
      },
      "transitions": [{ "event": "audioComplete", "next": "Hangup" }]
    },
    {
      "name": "Say_Error",
      "type": "say-play",
      "properties": {
        "say": "We are unable to complete your request at this time."
      },
      "transitions": [{ "event": "audioComplete", "next": "Hangup" }]
    },
    {
      "name": "Say_Goodbye",
      "type": "say-play",
      "properties": {
        "say": "Goodbye."
      },
      "transitions": [{ "event": "audioComplete", "next": "Hangup" }]
    },
    {
      "name": "Hangup",
      "type": "hangup",
      "transitions": []
    }
  ],
  "initial_state": "Trigger",
  "flags": { "allow_concurrent_calls": true }
}
