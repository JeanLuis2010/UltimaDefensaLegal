<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Attorney Membership Payment | Ultima Defensa Legal</title>
<link rel="preconnect" href="https://www.paypal.com">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f6f7f9;margin:0}
  .wrap{max-width:960px;margin:32px auto;padding:20px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);padding:24px}
  h1{margin:0 0 8px}
  .muted{color:#666}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  label{font-weight:700}
  select,input[type="text"],input[type="email"]{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;margin-top:6px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{background:#0b6bcb;color:#fff;border:0;border-radius:10px;padding:12px 18px;font-size:16px;cursor:pointer}
  .btn.alt{background:#059669}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .price{font-size:22px;font-weight:800}
  .tag{background:#eef6ff;color:#0b6bcb;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
  .legal{font-size:13px;color:#444;line-height:1.55}
  .divider{height:1px;background:#e5e7eb;margin:18px 0}
  .notice{background:#f0fdf4;border:1px solid #bbf7d0;padding:12px;border-radius:8px}
  @media (max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Attorney Membership Payment</h1>
    <p class="muted" id="i-subtitle">Select your membership and complete checkout. Enter a promo code if applicable.</p>

    <div class="row" style="margin:10px 0 20px">
      <span>Language:</span>
      <button class="btn" type="button" id="btn-en">English</button>
      <button class="btn alt" type="button" id="btn-es">Español</button>
    </div>

    <div class="grid">
      <div>
        <label id="i-plan">Membership</label>
        <select id="plan"></select>
      </div>
      <div>
        <label id="i-email">Billing Email</label>
        <input id="email" type="email" placeholder="lawyer@example.com" required>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <label id="i-promo">Promo Code (Optional)</label>
        <input id="promo" type="text" placeholder="e.g., WNEU20">
        <div class="muted" id="i-promo-hint">Western New England University alumni may use <b>WNEU20</b> for 20% off.</div>
      </div>
      <div>
        <label id="i-bar">Bar Number</label>
        <input id="bar" type="text" placeholder="Your state bar number" required>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="justify-content:space-between">
      <div>
        <span class="tag" id="i-recurring">Recurring Billing</span>
        <div class="legal" id="i-recurring-copy" style="margin-top:8px">
          By clicking Pay, you authorize recurring charges to your card or PayPal account until you cancel.
        </div>
      </div>
      <div class="price" id="priceDisplay">$0 / month</div>
    </div>

    <div class="notice" style="margin-top:16px" id="i-terms-note">
      By joining, you accept the <a href="/attorney-agreement.html" target="_blank">Attorney Independent Contractor Agreement</a> (Delaware law; consumer claims against UDL in Palm Beach County, FL).
    </div>

    <div class="divider"></div>

    <!-- Payment Areas -->
    <div id="paypal-container" style="margin-bottom:10px;"></div>
    <div id="bank-container" style="margin-bottom:10px;"></div>

    <!-- Test Mode fallback -->
    <div class="row" style="gap:10px;margin-top:4px" id="testRow">
      <button class="btn" id="fakePay">Pay (Test Mode)</button>
      <span class="muted" id="i-fake-note">Real checkout appears here once PayPal/Bank gateway is connected.</span>
    </div>

    <div class="divider"></div>

    <div class="legal" id="i-legal">
      Attorneys are independent and solely responsible for legal services. Ultima Defensa Legal is not a law firm and provides a referral/subscription platform only. 
      Services are provided “as is.” Any disputes must be brought in Palm Beach County, Florida. See
      <a href="/terms.html">Terms</a>, <a href="/privacy.html">Privacy</a>, and <a href="/legal-notices.html">Legal Notices</a>.
    </div>
  </div>
</div>

<script src="/assets/js/payments-config.js"></script>
<script>
  const CFG = window.UDL_PAY_CONFIG;

  const T = {
    en: {
      subtitle:"Select your membership and complete checkout. Enter a promo code if applicable.",
      plan:"Membership",
      email:"Billing Email",
      promo:"Promo Code (Optional)",
      promoHint:"Western New England University alumni may use WNEU20 for 20% off.",
      bar:"Bar Number",
      recurring:"Recurring Billing",
      recurringCopy:"By clicking Pay, you authorize recurring charges to your card or PayPal account until you cancel.",
      termsNote:`By joining, you accept the <a href="/attorney-agreement.html" target="_blank">Attorney Independent Contractor Agreement</a> (Delaware law; consumer claims against UDL in Palm Beach County, FL).`,
      fakeNote:"Real checkout appears here once PayPal/Bank gateway is connected.",
      legal:`Attorneys are independent and solely responsible for legal services. Ultima Defensa Legal is not a law firm and provides a referral/subscription platform only. 
             Services are provided “as is.” Any disputes must be brought in Palm Beach County, Florida. See
             <a href="/terms.html">Terms</a>, <a href="/privacy.html">Privacy</a>, and <a href="/legal-notices.html">Legal Notices</a>.`
    },
    es: {
      subtitle:"Seleccione su membresía y complete el pago. Ingrese un código promocional si aplica.",
      plan:"Membresía",
      email:"Correo de Facturación",
      promo:"Código Promocional (Opcional)",
      promoHint:"Los exalumnos de Western New England University pueden usar WNEU20 para un 20% de descuento.",
      bar:"Número de Colegio",
      recurring:"Facturación Recurrente",
      recurringCopy:"Al hacer clic en Pagar, usted autoriza cargos recurrentes a su tarjeta o cuenta de PayPal hasta que cancele.",
      termsNote:`Al unirse, usted acepta el <a href="/attorney-agreement.html" target="_blank">Acuerdo de Abogado Contratista Independiente</a> (ley de Delaware; reclamaciones de consumidores contra UDL en el Condado de Palm Beach, FL).`,
      fakeNote:"El pago real aparecerá aquí cuando su pasarela de PayPal/Banco esté conectada.",
      legal:`Los abogados son independientes y los únicos responsables de sus servicios. Ultima Defensa Legal no es un bufete; provee una plataforma de suscripción y referidos.
             Los servicios se brindan “tal cual”. Cualquier disputa debe presentarse en el Condado de Palm Beach, Florida. Consulte <a href="/terms.html">Términos</a>, <a href="/privacy.html">Privacidad</a> y <a href="/legal-notices.html">Avisos Legales</a>.`
    }
  };

  // Build plan list from config (with optional WNEU discounted PayPal plans)
  const planSel = document.getElementById('plan');
  const priceDisplay = document.getElementById('priceDisplay');
  const promoInput = document.getElementById('promo');

  function loadPlans(){
    planSel.innerHTML = "";
    const plans = CFG.ATTORNEY_PLANS;
    Object.keys(plans).forEach(k=>{
      if(k==="discounted") return;
      const o = document.createElement('option');
      o.value = k;
      o.textContent = plans[k].label;
      o.dataset.price = plans[k].price;
      o.dataset.interval = plans[k].interval;
      o.dataset.paypalPlanId = plans[k].paypalPlanId || "";
      planSel.appendChild(o);
    });
  }

  function computePrice(){
    const opt = planSel.selectedOptions[0];
    const base = Number(opt.dataset.price||0);
    const code = (promoInput.value||"").trim().toUpperCase();
    const final = code==="WNEU20" ? Math.round(base*80)/100 : base; // 20% off
    priceDisplay.textContent = `$${final} / ${opt.dataset.interval}`;
  }

  planSel.addEventListener('change', computePrice);
  promoInput.addEventListener('input', computePrice);

  // i18n
  function setLang(lang){
    const t = T[lang];
    document.getElementById('i-subtitle').innerHTML=t.subtitle;
    document.getElementById('i-plan').innerHTML=t.plan;
    document.getElementById('i-email').innerHTML=t.email;
    document.getElementById('i-promo').innerHTML=t.promo;
    document.getElementById('i-promo-hint').innerHTML=t.promoHint;
    document.getElementById('i-bar').innerHTML=t.bar;
    document.getElementById('i-recurring').innerHTML=t.recurring;
    document.getElementById('i-recurring-copy').innerHTML=t.recurringCopy;
    document.getElementById('i-terms-note').innerHTML=t.termsNote;
    document.getElementById('i-fake-note').innerHTML=t.fakeNote;
    document.getElementById('i-legal').innerHTML=t.legal;
  }
  document.getElementById('btn-en').onclick=()=>setLang('en');
  document.getElementById('btn-es').onclick=()=>setLang('es');

  // PayPal render (supports separate discounted plan IDs if you set them)
  function selectedPayPalPlanId(){
    const opt = planSel.selectedOptions[0];
    const code = (promoInput.value||"").trim().toUpperCase();
    // If discounted Plan IDs exist in config and code is WNEU20, use them:
    if(code==="WNEU20" && CFG.ATTORNEY_PLANS.discounted && CFG.ATTORNEY_PLANS.discounted[opt.value]){
      return CFG.ATTORNEY_PLANS.discounted[opt.value].paypalPlanId || opt.dataset.paypalPlanId;
    }
    return opt.dataset.paypalPlanId;
  }

  function mountPayPal(){
    const planId = selectedPayPalPlanId();
    if(!planId){ console.warn("No PayPal plan id"); return; }

    window.paypal.Buttons({
      style:{ shape:'pill', label:'subscribe', layout:'vertical' },
      createSubscription: (data, actions)=> actions.subscription.create({ plan_id: planId }),
      onApprove: async (data)=>{
        const opt = planSel.selectedOptions[0];
        const payload = {
          provider:"paypal",
          subscriptionId:data.subscriptionID,
          plan: opt.value,
          email: document.getElementById('email').value,
          bar: document.getElementById('bar').value,
          promo: (promoInput.value||"").trim().toUpperCase()
        };
        try{
          await fetch(CFG.SERVER.ATTORNEY_WEBHOOK,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          window.location.href="/thankyou.html";
        }catch(e){ alert("Payment processed, but we could not confirm on server. Please contact support."); }
      }
    }).render('#paypal-container');
  }

  // Bank gateway placeholder
  async function mountBank(){
    if(!CFG.BANK.TOKENIZER_SCRIPT_URL) return;
    const s = document.createElement('script');
    s.src = CFG.BANK.TOKENIZER_SCRIPT_URL;
    s.onload = ()=>{
      const div = document.getElementById('bank-container');
      const btn = document.createElement('button');
      btn.className="btn alt";
      btn.textContent="Pay by Card (Bank Gateway)";
      btn.onclick = async ()=>{
        const opt = planSel.selectedOptions[0];
        // TODO: tokenize card here, then POST to your server to create subscription with promo considered server-side
        const token = "CARD_TOKEN_PLACEHOLDER";
        const payload = {
          token,
          plan: opt.value,
          email: document.getElementById('email').value,
          bar: document.getElementById('bar').value,
          promo: (promoInput.value||"").trim().toUpperCase()
        };
        try{
          const res = await fetch(CFG.BANK.CREATE_SUB_ENDPOINT,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          if(res.ok) window.location.href="/thankyou.html";
          else alert("Card payment failed. Please try again.");
        }catch(e){ alert("Network error. Please try again."); }
      };
      div.appendChild(btn);
    };
    document.body.appendChild(s);
  }

  // Boot
  function init(){
    // load plans
    planSel.innerHTML = "";
    const plans = CFG.ATTORNEY_PLANS;
    Object.keys(plans).forEach(k=>{
      if(k==="discounted") return;
      const o = document.createElement('option');
      o.value = k;
      o.textContent = plans[k].label;
      o.dataset.price = plans[k].price;
      o.dataset.interval = plans[k].interval;
      o.dataset.paypalPlanId = plans[k].paypalPlanId || "";
      planSel.appendChild(o);
    });

    computePrice(); setLang('en');

    // Enable providers
    if(CFG.ENABLE_PAYPAL){
      const s = document.createElement('script');
      s.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(CFG.PAYPAL.CLIENT_ID)}&components=buttons&vault=true&intent=subscription&currency=${CFG.PAYPAL.CURRENCY}`;
      s.onload = ()=>{ mountPayPal(); document.getElementById('testRow').style.display='none'; };
      document.body.appendChild(s);
    }
    if(CFG.ENABLE_BANK_GATEWAY){
      mountBank(); document.getElementById('testRow').style.display='none';
    }
  }
  init();

  // i18n buttons
  document.getElementById('btn-en').onclick=()=>setLang('en');
  document.getElementById('btn-es').onclick=()=>setLang('es');

  // Test mode
  document.getElementById('fakePay').addEventListener('click', ()=>{
    const opt = planSel.selectedOptions[0];
    const base = Number(opt.dataset.price||0);
    const code = (promoInput.value||"").trim().toUpperCase();
    const final = code==="WNEU20" ? Math.round(base*80)/100 : base;
    alert(`(Test Mode)\nPlan: ${opt.text}\nPromo: ${code||'—'}\nTotal: $${final} / ${opt.dataset.interval}\nNo real charge made.`);
  });
</script>
</body>
</html>
